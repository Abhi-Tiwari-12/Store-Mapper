<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSC Store Mapper 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            background: linear-gradient(to bottom right, #1e40af, #3b82f6);
            font-family: 'Inter', sans-serif;
        }
        .card {
            transform: translateY(0);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        .btn {
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn:hover {
            transform: scale(1.05);
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        table {
            table-layout: fixed;
            width: 100%;
        }
        th, td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .pincode-header {
            background-color: #1e40af;
            color: white;
            font-weight: 700;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto py-4 px-6">
            <h1 class="text-2xl font-bold text-blue-900">TSC Store Mapper 2.0</h1>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-8">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-xl font-semibold text-gray-800 mb-6 text-center">Pincode Store Finder</h2>
            
            <!-- Single Pincode Input -->
            <div class="bg-white p-8 rounded-xl shadow-lg card mb-6">
                <label for="pincodeInput" class="block text-sm font-medium text-gray-700 mb-2">Enter Pincode</label>
                <div class="flex gap-3">
                    <input type="text" id="pincodeInput" placeholder="6-digit pincode" class="flex-1 p-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-600">
                    <button id="fetchBtn" class="bg-blue-600 text-white py-3 px-6 rounded-lg font-medium btn hover:bg-blue-700">Fetch</button>
                </div>
            </div>
            
            <!-- File Upload -->
            <div class="bg-white p-8 rounded-xl shadow-lg card mb-6">
                <label for="csvFile" class="block text-sm font-medium text-gray-700 mb-2">Upload CSV or Excel File</label>
                <input type="file" id="csvFile" accept=".csv,.xlsx,.xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <button id="uploadBtn" class="mt-4 w-full bg-blue-600 text-white py-3 rounded-lg font-medium btn hover:bg-blue-700">Upload & Process</button>
                <div id="loading" class="hidden text-center text-gray-600 mt-4 text-sm">Processing...</div>
                <p id="error" class="text-red-600 text-sm mt-4 text-center hidden"></p>
            </div>
            
            <!-- Fallback Results -->
            <div id="fallbackResults" class="hidden">
                <div class="mb-6 bg-white p-6 rounded-xl shadow-lg card">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">Processing Progress</span>
                        <span id="fallbackProgressText" class="text-sm font-medium text-blue-700">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="fallbackProgressBar" class="bg-blue-600 h-3 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                <button id="fallbackExportBtn" class="hidden mb-6 bg-green-600 text-white py-3 px-6 rounded-lg font-medium btn hover:bg-green-700">Export to Excel</button>
                <div class="space-y-6">
                    <div id="fallbackResultsList"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-4">
        <div class="max-w-7xl mx-auto text-center">
            <p class="text-sm font-medium">Product by Abhishek Tiwari</p>
        </div>
    </footer>

    <script>
        const targetOrigin = window.location.origin; // e.g., http://127.0.0.1:3000

        async function fetchStoreData(pincodes, errorEl, updateProgress) {
            const loadingEl = document.getElementById('loading');
            const fallbackResultsEl = document.getElementById('fallbackResults');
            const fallbackProgressBar = document.getElementById('fallbackProgressBar');
            const fallbackProgressText = document.getElementById('fallbackProgressText');
            loadingEl.classList.remove('hidden');
            fallbackResultsEl.classList.add('hidden');

            const storeData = [];
            let processed = 0;

            for (const pincode of pincodes) {
                if (!/^\d{6}$/.test(pincode)) {
                    console.warn(`Invalid pincode: ${pincode}`);
                    continue;
                }
                try {
                    // Mock API response for testing
                    // const data = {
                    //     success: true,
                    //     stores: [
                    //         { storeId: `TSC${pincode}1`, storeName: `Store 1 for ${pincode}`, distance: 1, mapLink: 'http://maps.example.com', contact: '1234567890' }
                    //     ]
                    // };
                    const response = await fetch(`https://api.thesleepcompany.in/stores?pincode=${pincode}`, {
                        method: 'GET',
                        headers: {
                            'accept': '*/*',
                            'content-type': 'application/json',
                            'x-api-key': 'KPwkS7MFb71KXrezuxUYJaf4EnFGvgkK9kgWaf7q'
                        }
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const data = await response.json();
                    console.log(`API response for ${pincode}:`, data); // Debug log
                    if (data.success && data.stores && data.stores.length > 0) {
                        storeData.push({ pincode, stores: [data.stores[0]] });
                    }
                    processed++;
                    const progress = Math.min((processed / pincodes.length) * 100, 100);
                    updateProgress(progress);
                    fallbackProgressBar.style.width = `${progress}%`;
                    fallbackProgressText.textContent = `${Math.round(progress)}%`;
                } catch (error) {
                    console.error(`Error for pincode ${pincode}:`, error);
                    errorEl.textContent = `Error fetching data for ${pincode}: ${error.message}`;
                    errorEl.classList.remove('hidden');
                }
            }

            loadingEl.classList.add('hidden');
            if (!storeData.length) {
                errorEl.textContent = 'No valid store data found';
                errorEl.classList.remove('hidden');
                return null;
            }

            return { storeData, total: pincodes.length, processed };
        }

        function displayFallbackResults(storeData) {
            const fallbackResultsEl = document.getElementById('fallbackResults');
            const fallbackResultsList = document.getElementById('fallbackResultsList');
            const fallbackExportBtn = document.getElementById('fallbackExportBtn');
            fallbackResultsEl.classList.remove('hidden');
            fallbackResultsList.innerHTML = '';

            storeData.forEach(({ pincode, stores }, index) => {
                const pincodeSection = document.createElement('div');
                pincodeSection.className = 'mb-6';
                pincodeSection.innerHTML = `
                    <h3 class="pincode-header text-lg">Pincode: ${pincode}</h3>
                    <div class="bg-white p-6 rounded-xl shadow-lg card overflow-x-auto">
                        <table class="w-full text-sm text-gray-600 border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border p-2 text-left w-20">Store ID</th>
                                    <th class="border p-2 text-left w-48">Store Name</th>
                                    <th class="border p-2 text-left w-24">Distance (km)</th>
                                    <th class="border p-2 text-left w-24">Map Link</th>
                                    <th class="border p-2 text-left w-24">Contact</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${stores.map(store => `
                                    <tr>
                                        <td class="border p-2">${store.storeId || 'N/A'}</td>
                                        <td class="border p-2">${store.storeName || 'N/A'}</td>
                                        <td class="border p-2">${store.distance != null ? store.distance : 'N/A'}</td>
                                        <td class="border p-2"><a href="${store.mapLink || '#'}" target="_blank" class="text-blue-600 hover:underline">${store.mapLink ? 'View Map' : 'N/A'}</a></td>
                                        <td class="border p-2">${store.contact || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ${index < storeData.length - 1 ? '<hr class="my-4 border-gray-300">' : ''}
                `;
                fallbackResultsList.appendChild(pincodeSection);
            });

            fallbackExportBtn.classList.remove('hidden');
            fallbackExportBtn.onclick = () => {
                const wsData = [
                    ['Pincode', 'Store ID', 'Store Name', 'Distance (km)', 'Map Link', 'Contact']
                ];
                storeData.forEach(({ pincode, stores }) => {
                    stores.forEach(store => {
                        wsData.push([
                            pincode,
                            store.storeId || 'N/A',
                            store.storeName || 'N/A',
                            store.distance != null ? store.distance : 'N/A',
                            store.mapLink || 'N/A',
                            store.contact || 'N/A'
                        ]);
                    });
                });
                try {
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Stores');
                    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                    const blob = new Blob([wbout], { type: 'application/octet-stream' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'store_data.xlsx';
                    a.click();
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Export error:', error);
                    const errorEl = document.getElementById('error');
                    errorEl.textContent = 'Failed to export to Excel';
                    errorEl.classList.remove('hidden');
                }
            };
        }

        async function sendDataToResultWindow(result) {
            console.log('Sending result:', result); // Debug log
            const resultWindow = window.open('result.html', '_blank');
            if (!resultWindow) {
                const errorEl = document.getElementById('error');
                errorEl.textContent = 'Popup blocked. Displaying results below...';
                errorEl.classList.remove('hidden');
                displayFallbackResults(result.storeData);
                return;
            }
            setTimeout(() => {
                try {
                    const message = {
                        type: 'storeData',
                        data: result
                    };
                    const jsonData = JSON.stringify(message);
                    console.log('Sending JSON to result.html:', jsonData); // Debug log
                    resultWindow.postMessage(jsonData, targetOrigin);
                } catch (error) {
                    console.error('postMessage error:', error);
                    const errorEl = document.getElementById('error');
                    errorEl.textContent = 'Failed to send data to results page';
                    errorEl.classList.remove('hidden');
                    displayFallbackResults(result.storeData);
                }
            }, 500); // Delay to ensure result.html loads
        }

        document.getElementById('fetchBtn').addEventListener('click', async () => {
            const pincodeInput = document.getElementById('pincodeInput');
            const errorEl = document.getElementById('error');
            const loadingEl = document.getElementById('loading');
            errorEl.classList.add('hidden');
            loadingEl.classList.remove('hidden');

            const pincode = pincodeInput.value.trim().replace(/\D/g, '');
            if (!pincode) {
                errorEl.textContent = 'Please enter a pincode';
                errorEl.classList.remove('hidden');
                loadingEl.classList.add('hidden');
                return;
            }
            if (!/^\d{6}$/.test(pincode)) {
                errorEl.textContent = 'Please enter a valid 6-digit pincode';
                errorEl.classList.remove('hidden');
                loadingEl.classList.add('hidden');
                return;
            }

            const result = await fetchStoreData([pincode], errorEl, (progress) => {
                console.log(`Progress: ${progress}%`); // Debug log
            });
            loadingEl.classList.add('hidden');
            if (!result) return;

            sendDataToResultWindow(result);
        });

        document.getElementById('uploadBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('csvFile');
            const errorEl = document.getElementById('error');
            const loadingEl = document.getElementById('loading');
            errorEl.classList.add('hidden');
            loadingEl.classList.remove('hidden');

            if (!fileInput.files.length) {
                errorEl.textContent = 'Please select a CSV or Excel file';
                errorEl.classList.remove('hidden');
                loadingEl.classList.add('hidden');
                return;
            }

            const file = fileInput.files[0];
            const fileExt = file.name.split('.').pop().toLowerCase();

            let pincodes = [];
            try {
                if (fileExt === 'csv') {
                    const text = await file.text();
                    pincodes = text.split('\n').map(line => line.trim()).filter(line => line && /^\d{6}$/.test(line));
                } else if (['xlsx', 'xls'].includes(fileExt)) {
                    const reader = new FileReader();
                    pincodes = await new Promise((resolve, reject) => {
                        reader.onload = (e) => {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                                const pins = rows.map(row => String(row[0]).trim()).filter(pin => pin && /^\d{6}$/.test(pin));
                                resolve(pins);
                            } catch (error) {
                                reject(error);
                            }
                        };
                        reader.onerror = () => reject(new Error('Failed to read file'));
                        reader.readAsArrayBuffer(file);
                    });
                } else {
                    throw new Error('Unsupported file format. Please upload CSV or Excel.');
                }
            } catch (error) {
                console.error('File processing error:', error);
                errorEl.textContent = error.message;
                errorEl.classList.remove('hidden');
                loadingEl.classList.add('hidden');
                return;
            }

            if (!pincodes.length) {
                errorEl.textContent = 'No valid pincodes found in file';
                errorEl.classList.remove('hidden');
                loadingEl.classList.add('hidden');
                return;
            }

            const result = await fetchStoreData(pincodes, errorEl, (progress) => {
                console.log(`Progress: ${progress}%`); // Debug log
            });
            loadingEl.classList.add('hidden');
            if (!result) return;

            sendDataToResultWindow(result);
        });
    </script>
</body>
</html>