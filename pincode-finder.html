<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pincode Finder - TSC Store Mapper</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background: #F7FAFC; }

    .sidebar { transition: transform 0.3s ease; }
    .nav-item:hover, .nav-item.active { background-color: #2DD4BF !important; color: #fff !important; }

    .card {
      background: white;
      border-radius: 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    .dropdown-btn {
      background: white;
      border: 2px solid #e5e7eb;
      padding: 1.2rem 1.5rem;
      border-radius: 1rem;
      cursor: pointer;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 1.1rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(0,0,0,0.06);
    }
    .dropdown-btn:hover { border-color: #14b8a6; box-shadow: 0 10px 30px rgba(20,184,166,0.2); transform: translateY(-2px); }

    .dropdown-menu {
      position: absolute;
      top: 100%; left: 0; right: 0;
      margin-top: 12px;
      background: rgba(255,255,255,0.98);
      backdrop-filter: blur(20px);
      border: 1.5px solid #e5e7eb;
      border-radius: 1.2rem;
      box-shadow: 0 20px 50px rgba(0,0,0,0.18);
      overflow: hidden;
      z-index: 50;
      opacity: 0; visibility: hidden;
      transform: translateY(-15px) scale(0.95);
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .dropdown-menu.open { opacity: 1; visibility: visible; transform: translateY(0) scale(1); }

    .dropdown-item {
      padding: 1.1rem 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 14px;
      opacity: 0;
      transform: translateX(-20px);
      transition: all 0.3s ease;
    }
    .dropdown-item.visible { opacity: 1; transform: translateX(0); }
    .dropdown-item:hover { background: #ecfdf5; padding-left: 2rem; }

    .spinner-modern {
      width: 70px; height: 70px;
      border: 6px solid rgba(255,255,255,0.15);
      border-top: 6px solid #14b8a6;
      border-radius: 50%;
      animation: spin 1.3s cubic-bezier(0.4, 0, 0.2, 1) infinite;
      position: relative;
    }
    .spinner-modern::after {
      content: ''; position: absolute;
      inset: 6px;
      border: 6px solid transparent;
      border-top: 6px solid #5eead4;
      border-radius: 50%;
      animation: spin 2s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* OVERLAY ONLY ON MAIN CONTENT - NOT SIDEBAR/HEADER/FOOTER */
    #contentOverlay {
      position: fixed;
      top: 64px;        /* below header (h-16 = 64px) */
      left: 254px;      /* right of sidebar (w-64 = 256px) */
      right: 0;
      bottom: 52px;     /* above footer */
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 998;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s ease;
    }
    #contentOverlay.active {
      opacity: 1;
      visibility: visible;
    }

    .fetch-btn, .export-btn {
      background: linear-gradient(135deg, #14b8a6, #0d9488);
      color: white;
      border: none;
      padding: 0.9rem 2.5rem;
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(20,184,166,0.3);
      transition: all 0.3s ease;
    }
    .fetch-btn:hover, .export-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(20,184,166,0.4); }
    .export-btn { background: linear-gradient(135deg, #10b981, #059669); }
  </style>
</head>
<body class="min-h-screen flex">

  <!-- Overlay - NOW ONLY COVERS MAIN CONTENT -->
  <div id="contentOverlay">
    <div class="spinner-modern"></div>
    <p id="loadingText" class="mt-10 text-2xl font-medium text-white tracking-wide">Analyzing your preference...</p>
  </div>

  <!-- Sidebar - Always visible -->
  <aside class="fixed top-0 left-0 h-full w-64 bg-gray-900 text-white p-6 flex flex-col z-30">
    <div class="flex items-center mb-8">
      <i class="fas fa-store text-2xl text-teal-400 mr-3"></i>
      <h2 class="text-xl font-bold">TSC Mapper</h2>
    </div>
    <nav class="flex-1">
      <ul class="space-y-2">
        <li><a href="Mapper.html" class="nav-item flex items-center p-3 rounded-lg"><i class="fas fa-home mr-3"></i>Home</a></li>
        <li><a href="pincode-finder.html" class="nav-item flex items-center p-3 rounded-lg bg-teal-500 active"><i class="fas fa-search-location mr-3"></i>Pincode Finder</a></li>
        <li><a href="result.html" class="nav-item flex items-center p-3 rounded-lg"><i class="fas fa-table mr-3"></i>Results</a></li>
        <li><a href="index.html" class="nav-item flex items-center p-3 rounded-lg"><i class="fas fa-sign-out-alt mr-3"></i>Logout</a></li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content Area -->
  <div class="flex-1 md:ml-64 flex flex-col min-h-screen">
    
    <!-- Header - Always visible -->
    <header class="bg-white shadow sticky top-0 z-20 h-16">
      <div class="max-w-7xl mx-auto py-4 px-6 flex items-center justify-between h-full">
        <h1 class="text-2xl font-bold text-gray-900">Pincode Finder</h1>
        <div class="flex items-center gap-3">
          <span class="text-sm text-gray-600">Admin User</span>
          <i class="fas fa-user-circle text-2xl text-teal-400"></i>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-1 p-6 lg:p-8">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-xl font-semibold text-gray-900 mb-6">Select a Store to View Serviceable Pincodes</h2>

        <div class="card p-8 lg:p-10">
          <div class="relative">
            <button id="dropdownBtn" class="w-full dropdown-btn">
              <span id="selectedStore" class="text-gray-900">Loading stores...</span>
              <i class="fas fa-chevron-down text-gray-400 transition-transform duration-300" id="chevron"></i>
            </button>

            <div id="dropdownMenu" class="dropdown-menu">
              <div class="p-4 border-b sticky top-0 bg-white z-10">
                <input type="text" id="searchInput" placeholder="Search store..." class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 text-sm">
              </div>
              <div id="storeList" class="max-h-96 overflow-y-auto"></div>
            </div>
          </div>

          <div class="flex justify-center mt-8">
            <button id="fetchBtn" class="fetch-btn hidden">
              <i class="fas fa-search mr-2"></i>Fetch Pincodes
            </button>
          </div>
        </div>

        <div id="resultsSection" class="mt-8 hidden">
          <div class="card p-8">
            <div id="resultsContent"></div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer - Always visible -->
    <footer class="bg-gray-900 text-white py-4 text-center text-sm mt-auto">
      Product by Abhishek Tiwari | TSC Store Mapper v2.0
    </footer>
  </div>

  <script>
    const dropdownBtn = document.getElementById('dropdownBtn');
    const dropdownMenu = document.getElementById('dropdownMenu');
    const searchInput = document.getElementById('searchInput');
    const storeList = document.getElementById('storeList');
    const chevron = document.getElementById('chevron');
    const selectedStore = document.getElementById('selectedStore');
    const fetchBtn = document.getElementById('fetchBtn');
    const resultsSection = document.getElementById('resultsSection');
    const resultsContent = document.getElementById('resultsContent');
    const contentOverlay = document.getElementById('contentOverlay');
    const loadingText = document.getElementById('loadingText');

    let allStores = [];
    let selectedStoreName = null;
    let messageTimeouts = [];
    let currentResults = [];

    const CACHE_KEY_PREFIX = 'tsc_pincodes_';
    const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours

    const loadingMessages = [
      "Analyzing your preference...",
      "Fetching pincodes from server...",
      "Calculating distances...",
      "Preparing results...",
      "Almost ready!"
    ];

    // AUTO SWITCH: Local dev vs Live
    const getProxyUrl = () => {
      return location.hostname === 'localhost' || location.hostname === '127.0.0.1'
        ? 'http://localhost:3001/pincodes'
        : 'https://pincode-proxy.onrender.com/pincodes';  // CORRECT ENDPOINT
    };

    // CACHING SYSTEM
    const getCacheKey = (store) => `${CACHE_KEY_PREFIX}${store.toLowerCase().replace(/\s+/g, '_')}`;
    const getCachedData = (store) => {
      try {
        const cached = localStorage.getItem(getCacheKey(store));
        if (!cached) return null;
        const { data, timestamp } = JSON.parse(cached);
        if (Date.now() - timestamp > CACHE_DURATION) {
          localStorage.removeItem(getCacheKey(store));
          return null;
        }
        return data;
      } catch {
        return null;
      }
    };
    const setCachedData = (store, data) => {
      try {
        localStorage.setItem(getCacheKey(store), JSON.stringify({ data, timestamp: Date.now() }));
      } catch (e) {
        console.warn("Cache full – clearing old data");
        localStorage.clear();
      }
    };

    // UI Logic
    dropdownBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      dropdownMenu.classList.toggle('open');
      chevron.classList.toggle('rotate-180');
      if (dropdownMenu.classList.contains('open')) searchInput.focus();
    });

    document.addEventListener('click', (e) => {
      if (!dropdownBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
        dropdownMenu.classList.remove('open');
        chevron.classList.remove('rotate-180');
      }
    });

    storeList.addEventListener('click', (e) => {
      const item = e.target.closest('.dropdown-item');
      if (!item) return;
      selectedStoreName = item.dataset.name;
      selectedStore.textContent = selectedStoreName;
      renderStores(allStores);
      dropdownMenu.classList.remove('open');
      chevron.classList.remove('rotate-180');
      searchInput.value = '';
      fetchBtn.classList.remove('hidden');
      resultsSection.classList.add('hidden');
    });

    function renderStores(list) {
      if (!list.length) {
        storeList.innerHTML = `<div class="p-12 text-center text-gray-500">No stores found</div>`;
        return;
      }
      storeList.innerHTML = list.map((store, i) => `
        <div class="dropdown-item" data-name="${store.name}" style="animation-delay: ${i * 0.05}s">
          <i class="fas fa-store text-teal-500"></i>
          <span>${store.name}</span>
        </div>
      `).join('');
      setTimeout(() => document.querySelectorAll('.dropdown-item').forEach(el => el.classList.add('visible')), 50);
    }

    searchInput.addEventListener('input', () => {
      const term = searchInput.value.toLowerCase();
      const filtered = allStores.filter(s => s.name.toLowerCase().includes(term));
      renderStores(filtered);
    });

    function showOverlay() {
      contentOverlay.classList.add('active');
      let i = 0;
      const next = () => {
        if (i < loadingMessages.length && contentOverlay.classList.contains('active')) {
          loadingText.textContent = loadingMessages[i++];
          messageTimeouts.push(setTimeout(next, 8000));
        }
      };
      next();
    }

    function hideOverlay() {
      messageTimeouts.forEach(clearTimeout);
      messageTimeouts = [];
      contentOverlay.classList.remove('active');
    }

    function exportToExcel() {
      if (!currentResults.length) return;
      const data = currentResults.map(r => ({
        Pincode: r.pincode,
        "Distance (km)": r.distance_km.toFixed(1)
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Pincodes");
      const safeName = (selectedStoreName || "Store").replace(/[^a-zA-Z0-9]/g, "_");
      XLSX.writeFile(wb, `TSC_Pincodes_${safeName}.xlsx`);
    }

    // MAIN FETCH BUTTON – NOW 100% CORRECT & CACHED
    fetchBtn.addEventListener('click', async () => {
      resultsSection.classList.remove('hidden');
      resultsContent.innerHTML = '';
      showOverlay();

      // 1. Try cache first (instant!)
      const cached = getCachedData(selectedStoreName);
      if (cached) {
        hideOverlay();
        currentResults = cached;
        renderResults(cached, true);
        return;
      }

      // 2. Fetch from server
      try {
        const response = await fetch(getProxyUrl(), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ store: selectedStoreName })
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(`Server returned ${response.status}: ${text}`);
        }

        const data = await response.json();
        const results = data.results || [];

        setCachedData(selectedStoreName, results);
        hideOverlay();
        currentResults = results;
        renderResults(results, false);

      } catch (err) {
        console.error('Fetch error:', err);
        hideOverlay();
        resultsContent.innerHTML = `
          <div class="text-center py-12 text-red-600">
            <p>Failed to fetch pincodes</p>
            <p class="text-sm mt-2">Check internet or try again later</p>
          </div>`;
      }
    });

    function renderResults(results, fromCache = false) {
      if (!results.length) {
        resultsContent.innerHTML = `<div class="text-center py-20 text-gray-500">No serviceable pincodes found</div>`;
        return;
      }

      results.sort((a, b) => a.distance_km - b.distance_km);
      const maxDist = Math.max(...results.map(r => r.distance_km)).toFixed(1);

      resultsContent.innerHTML = `
        <div class="text-center mb-8">
          <p class="text-xl font-semibold text-gray-800">
            Found <strong class="text-teal-600">${results.length}</strong> serviceable pincodes!
            ${fromCache ? '<span class="inline-block ml-3 px-3 py-1 bg-green-100 text-green-700 text-sm rounded-full animate-pulse">⚡ Cached</span>' : ''}
          </p>
        </div>

        <div class="overflow-x-auto rounded-xl border border-gray-100 mb-6">
          <table class="w-full">
            <thead class="bg-gradient-to-r from-teal-50 to-cyan-50">
              <tr>
                <th class="p-4 text-left font-semibold text-teal-800">Pincode</th>
                <th class="p-4 text-left font-semibold text-teal-800">Distance</th>
              </tr>
            </thead>
            <tbody>
              ${results.map(r => `
                <tr class="border-b hover:bg-teal-50 transition">
                  <td class="p-4 font-mono font-semibold text-teal-700">${r.pincode}</td>
                  <td class="p-4">${r.distance_km.toFixed(1)} km</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 items-center justify-between">
          <p class="text-sm text-gray-600">
            Maximum radius: <span class="font-bold text-teal-600">${maxDist} km</span>
            ${fromCache ? ' • <span class="text-green-600">Loaded instantly from cache</span>' : ''}
          </p>
          <button onclick="exportToExcel()" class="export-btn flex items-center gap-2">
            <i class="fas fa-file-excel"></i> Download Excel
          </button>
        </div>
      `;
    }

    // Load stores on start
    (async () => {
      try {
        const res = await fetch('https://api.thesleepcompany.in/stores', {
          headers: { 'x-api-key': 'KPwkS7MFb71KXrezuxUYJaf4EnFGvgkK9kgWaf7q' }
        });
        const { stores = [] } = await res.json();
        allStores = stores
          .map(s => ({ name: (s.storeName || '').trim() }))
          .filter(s => s.name)
          .sort((a, b) => a.name.localeCompare(b.name));

        if (allStores.length) {
          renderStores(allStores);
          selectedStoreName = allStores[0].name;
          selectedStore.textContent = selectedStoreName;
          fetchBtn.classList.remove('hidden');
        }
      } catch (err) {
        storeList.innerHTML = `<div class="p-12 text-center text-red-600">Failed to load stores list</div>`;
      }
    })();
</script>
</body>
</html>